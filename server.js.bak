import express from "express";
import bodyParser from "body-parser";
import axios from "axios";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const app = express();
app.use(bodyParser.json());

// Initialize OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ========== VERIFY WEBHOOK (for Meta setup) ==========
app.get("/webhook", (req, res) => {
  const verify_token = process.env.VERIFY_TOKEN;
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode && token === verify_token) {
    console.log("✅ Webhook verified!");
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

// ========== HANDLE INCOMING WHATSAPP MESSAGES ==========
app.post("/webhook", async (req, res) => {
  const body = req.body;

  if (body.object) {
    const message = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
    const from = message?.from; // customer’s number
    const text = message?.text?.body; // message body

    if (text) {
      console.log("📩 Received:", text);

      // Generate GPT-based response
      const reply = await generateReply(text);

      // Send back to user
      await sendMessage(from, reply);
    }

    res.sendStatus(200);
  } else {
    res.sendStatus(404);
  }
});

// ========== FUNCTION: Generate AI reply ==========
async function generateReply(userMessage) {
  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content:
            "You are a helpful WhatsApp assistant for a small business. Be polite, short, and clear.",
        },
        { role: "user", content: userMessage },
      ],
    });

    return completion.choices[0].message.content;
  } catch (err) {
    console.error("❌ GPT error:", err.message);
    return "Sorry, I’m having trouble understanding you right now.";
  }
}

// ========== FUNCTION: Send WhatsApp Message ==========
async function sendMessage(to, message) {
  try {
    await axios.post(
      `https://graph.facebook.com/v21.0/${process.env.PHONE_NUMBER_ID}/messages`,
      {
        messaging_product: "whatsapp",
        to,
        type: "text",
        text: { body: message },
      },
      {
        headers: {
          Authorization: `Bearer ${process.env.WHATSAPP_TOKEN}`,
          "Content-Type": "application/json",
        },
      }
    );
    console.log("✅ Sent to:", to);
  } catch (err) {
    console.error("❌ WhatsApp send error:", err.response?.data || err.message);
  }
}

// ========== START SERVER ==========
app.listen(process.env.PORT, () =>
  console.log(`🚀 Server running on port ${process.env.PORT}`)
);
